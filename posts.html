<!DOCTYPE html>
<html>
<head>
<meta http-equiv='content-type' content='text/html;charset=utf-8' />
<title>Заметки / Сайт Григория Еремина</title>
<link rel="shortcut icon" href="/static/img/favicon.ico?1322400151" />
<link rel="stylesheet" href="/static/css/main.css" />
<link rel="stylesheet" href="/static/css/markdown.css" />
<script src="/static/share42/share42.js"></script>
<script src="/static/js/utils/updater.js"></script>
<script src="/static/js/3rdparty/showdown.js"></script>
<script src='/static/js/main.js'></script>
</head>
<body>
<script type='text/javascript'>

  var converter = new showdown.Converter();

  function addPost(r, p){
    var text, html;
    var root = document.createElement('div');
    root.className = 'wrap';
    // +anchor <a id="id5653374286430208" name="id5653374286430208"></a> !!!
    var content = document.createElement('div');
    root.appendChild(content);
    content.className = 'msgtext';
    var header = document.createElement('h3');
    content.appendChild(header);
    var a = document.createElement('a');
    header.appendChild(a);
    a.className = 'nodecor';
    a.href = '/posts/' + p.subj + '/' + p.title[1];
    a.appendChild(document.createTextNode( p.title[1] ));
      // to markdown
    text = r
      .replace(/\/photos\//g, '/fotos/')
      .replace(/\r\r\n/g, '\n')
      .replace(/\r*\n>\r*\n*/g, '\n<p></p>\n')
      .replace(/\{: class=rounded :\}/g, '');
    html = converter.makeHtml(text);
    content.innerHTML += html;
    var footer = document.createElement('div');
    root.appendChild(footer);
    footer.className = 'msgfooter';
    var a = document.createElement('a');
    footer.appendChild(a);
    a.className = 'nodecor';
    a.href = '/posts/' + p.subj;    
    a.appendChild(document.createTextNode( p.subj ));
    var ps = document.createElement('div');
    footer.appendChild(ps);
    ps.className = 'gray smaller';
    ps.appendChild(document.createTextNode(p.title[2]));
    return root;
  }

  addMetaTags( 'Заметки, Посты' );
  addBodyTags( 'posts' );

  var p = document.createElement('p');
  document.getElementById('page_content').appendChild(p);
  p.className = 'mtext hspace';
  p.appendChild(document.createTextNode('Заметки, статьи, цитаты на самые разные темы.'));
  
  upfunc({url: '/posts/titles.map'}, function(r){
    r = eval(r);
    var per_page = 10,
        page_num = urlParams().page||1,
        page_bottom = (page_num-1)*per_page,
        page_top = page_bottom+per_page;
    var subjects = r[0],
        titles = r[1],
        page_titles = r[1].slice(page_bottom, page_top);
    for(var i=0; i<page_titles.length; i++){
      var subj = subjects[ page_titles[i][0] ],
          title = page_titles[i][1];
      upfunc({last: i == page_titles.length-1, subj: subj, title: page_titles[i], url: '/posts/' + subj + '/' + title + '.txt'}, function(r, p){
        document.getElementById('page_content').appendChild(addPost(r, p));
        if (p.last)
          document.getElementById('page_content').appendChild(addPaginator(titles, per_page, page_num));
      });
    }
  });

</script>
</body>
</html>
