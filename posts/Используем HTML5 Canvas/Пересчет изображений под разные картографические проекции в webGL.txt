<!--2015-05-19 19:42:54-->
В посте на своем блоге ["gdal_translate и gdalwarp для перепроицирования изображений"](http://egaxegax.appspot.com/guestbook/1122002) описывался процесс получения картинок под разные проекции с помощью утилит GDAL. Полученные изображения я использовал как подложку для карт в примерах проекта [dbCartajs](http://github.com/egaxegax/dbCartajs). Позже, работая над портированием канвасной версии своего планетария на webGL, описанной в статье ["Звездное небо на webGL с использованием three.js"](http://egaxegax.appspot.com/guestbook/4662364972515328) на Хабре, у меня возникла мысль со временем перенести не только глобус, но и плоские на карты на webGL, используя вместо фона текстуры.

![buttefly.png](https://img-fotki.yandex.ru/get/4209/136640652.1/0_112d01_d8377bc9_orig.png)

Мысль так и оставалась мыслью пока я не познакомился с очень интересным примером отображения картинки в разных проекциях на webGL ["Spinnable World Maps"](http://vcg.isti.cnr.it/~tarini/spinnableworldmaps/) от Марко Тарини. Этот пример показал коллега по работе еще год назад, но заинтересовался я им недавно. Код примера интересен еще и оригинальными комментариями автора на итальянском, например *punto centrale* или *mostra/nasconde griglia*.

Код Тарини оказался насыщен вычислениями всего чего угодно: размеров экрана, координат курсора мыши в пикселах и треугольниках, координат геометрий проекций, матриц поворота геометрий. При этом полностью картинка с меридианами и измененными цветами формируется в шейдерах. Мне захотелось отрисовать что-нибудь на этой карте, скажем границы стран. Но для этого пришлось бы вставлять код вычислений пикселов линий в код шейдера как с случае с меридианами, а это уже слишком. Поэтому возникла мысль совместить изображение карты в канвасе 2d с перепроицированием через webGL и формулы Тарини. То есть использовать канвас как источник текстуры для наложения на геометрию. В исходниках Three.js встречаются такие примеры.

Из кода Spinnable Maps я взял в основном вычислительные формулы, а из примеров dbcartajs - логику создания карты по слоям, пересчет координат мыши в пиксели, таймер. Результат слияния двух проектов можно посмотреть [здесь](http://dbcartajs.appspot.com/map3d.html).

Управлять картой можно мышью. При таскании мышью происходит вращение карты по сфере по 3 осям, а не смещение на плоскости. Это порождает эффект бесконечного зацикливания карты вдоль оси X.