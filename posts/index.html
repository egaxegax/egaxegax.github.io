<!DOCTYPE html>
<html>
<head>
<meta http-equiv='content-type' content='text/html;charset=utf-8' />
<title>Заметки / Сайт Григория Еремина</title>
<meta name="description" content="Заметки, цитаты, статьи и посты на самые разные темы."/>
<meta name="keywords" content="статьи, тексты, заметки, фото"/>
<link rel="shortcut icon" href="/static/img/favicon.ico" />
<link rel='stylesheet' href='/static/css/main.css' />
<link rel='stylesheet' href='/static/css/markdown.css' />
<script src='/static/js/metrics.js'></script>
<script src='/static/share42/share42.js'></script>
<script src='/static/js/updater.js'></script>
<script src='/static/js/3rdparty/showdown.min.js'></script>
<script src='/static/js/main.js'></script>
</head>
<body>
<script type='text/javascript'>

  addMetaTags();
  addBodyTags( 'posts' );
  addMetrics();

  function addPost(r, p){
    var root = document.createElement('div');
    var content = document.createElement('div');
    root.appendChild(content);
    content.className = 'msgtext';
    if(p.title[2] != 'about'){
      var header = document.createElement('h3');
      content.appendChild(header);
      var a = document.createElement('a');
      header.appendChild(a);
      a.className = 'nodecor';
      a.href = '?' + p.title[1];
      a.appendChild(document.createTextNode( p.title[2] ));
    }
      // to markdown
    var text = r
      .replace(/\/photos\//g, '/fotos/')
      .replace(/\r\r\n/g, '\n')
      .replace(/\r*\n>\r*\n*/g, '\n<p></p>\n')
      .replace(/\{: class=rounded :\}/g, '');
    var converter = new showdown.Converter();
    var html = converter.makeHtml(text);
    content.innerHTML += html;
    if(p.title[2] != 'about'){
      var footer = document.createElement('div');
      root.appendChild(footer);
      footer.className = 'msgfooter';
      var a = document.createElement('a');
      footer.appendChild(a);
      a.className = 'nodecor';
      a.href = '?' + p.title[0];    
      a.appendChild(document.createTextNode( p.subj ));
      var ps = document.createElement('div');
      footer.appendChild(ps);
      ps.className = 'gray smaller';
      ps.appendChild(document.createTextNode(' ' + p.title[3]));
    }
    return root.innerHTML;
  }

  var p = document.createElement('p');
  document.getElementById('page_content').appendChild(p);
  p.className = 'mtext hspace';
  p.appendChild(document.createTextNode('Заметки, статьи, цитаты на самые разные темы.'));
  
  loadScript({url: '/posts/index.js'}, function(p){
    var subjects = SUBJ,
        titles = TITLES;
    var per_page = 10,
        page_num = urlParams().page||1,
        page_bottom = (page_num-1)*per_page,
        page_top = page_bottom+per_page;
    for(var p in urlParams()){
      if (urlParams()[p] == '') titles = titles.filter(function(tit){ return (tit[ parseInt(p[0]) ] === p); });
        // +about page
      if(titles.length && parseInt(p[0]) == 0) titles = [[titles[0][0], titles[0][0], 'about','']].concat(titles);
    }
    var page_titles = titles.slice(page_bottom, page_top);
    for(var i=0; i<page_titles.length; i++){
      var subj = subjects[ parseInt(page_titles[i][0]) ], // skip lead 0 subj
          title = page_titles[i][2];
      var wrap = document.createElement('div');
      wrap.id = 'post' + i;
      document.getElementById('page_content').appendChild(wrap);
      upfunc({id: wrap.id, subj: subj, title: page_titles[i], url: subj + '/' + title + '.txt'}, function(r, p){
        if(r.search('Error 404') == -1 && r.search('File not found') == -1) { // skip Not Found pages 
          var el = document.getElementById(p.id);
          el.className = 'wrap';
          el.innerHTML = addPost(r, p);
            // add description meta
          if(p.id == 'post0'){
            var meta = document.head.getElementsByTagName('meta');
            for(var j in meta){
              if(meta[j].name == 'description') meta[j].content = el.innerHTML.replace(/(<([^>]+)>)/gi, "");
            }
          }
        }
      });
    }
    if (!page_titles.length){
      var p = document.createElement('p');
      document.getElementById('page_content').appendChild(p);
      p.className = 'mtext hspace';
      p.appendChild(document.createTextNode('Нет данных.'));
    } else
      document.getElementById('page_footer').appendChild(addPaginator(titles, per_page, page_num));
  });

</script>
</body>
</html>
